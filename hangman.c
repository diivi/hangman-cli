#include <ctype.h>
#include <curl/curl.h>
#include <jansson.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
// #include <unistd.h>
// #include <dos.h>
#include <time.h>

// couldn't a better way to display ascii art in c
unsigned char ascii_intro[] = {
    0x20, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x20, 0x0a, 0x7c, 0x20, 0x7c,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x20, 0x20,
    0x5f, 0x5f, 0x20, 0x5c, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x7c, 0x5f,
    0x20, 0x20, 0x20, 0x5f, 0x7c, 0x0a, 0x7c, 0x20, 0x7c, 0x5f, 0x5f, 0x20,
    0x20, 0x20, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x5f, 0x20,
    0x20, 0x20, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x5f, 0x20,
    0x5f, 0x5f, 0x5f, 0x20, 0x20, 0x20, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x5f,
    0x20, 0x5f, 0x5f, 0x20, 0x20, 0x20, 0x7c, 0x20, 0x2f, 0x20, 0x20, 0x5c,
    0x2f, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20, 0x7c,
    0x20, 0x20, 0x0a, 0x7c, 0x20, 0x27, 0x5f, 0x20, 0x5c, 0x20, 0x2f, 0x20,
    0x5f, 0x60, 0x20, 0x7c, 0x20, 0x27, 0x5f, 0x20, 0x5c, 0x20, 0x2f, 0x20,
    0x5f, 0x60, 0x20, 0x7c, 0x20, 0x27, 0x5f, 0x20, 0x60, 0x20, 0x5f, 0x20,
    0x5c, 0x20, 0x2f, 0x20, 0x5f, 0x60, 0x20, 0x7c, 0x20, 0x27, 0x5f, 0x20,
    0x5c, 0x20, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20,
    0x7c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x20, 0x0a,
    0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x28, 0x5f, 0x7c, 0x20,
    0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x28, 0x5f, 0x7c, 0x20,
    0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20,
    0x28, 0x5f, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20,
    0x7c, 0x20, 0x5c, 0x5f, 0x5f, 0x2f, 0x5c, 0x7c, 0x20, 0x7c, 0x5f, 0x5f,
    0x5f, 0x5f, 0x5f, 0x7c, 0x20, 0x7c, 0x5f, 0x20, 0x0a, 0x7c, 0x5f, 0x7c,
    0x20, 0x7c, 0x5f, 0x7c, 0x5c, 0x5f, 0x5f, 0x2c, 0x5f, 0x7c, 0x5f, 0x7c,
    0x20, 0x7c, 0x5f, 0x7c, 0x5c, 0x5f, 0x5f, 0x2c, 0x20, 0x7c, 0x5f, 0x7c,
    0x20, 0x7c, 0x5f, 0x7c, 0x20, 0x7c, 0x5f, 0x7c, 0x5c, 0x5f, 0x5f, 0x2c,
    0x5f, 0x7c, 0x5f, 0x7c, 0x20, 0x7c, 0x5f, 0x7c, 0x20, 0x20, 0x5c, 0x5f,
    0x5f, 0x5f, 0x5f, 0x2f, 0x5c, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x2f, 0x5c,
    0x5f, 0x5f, 0x5f, 0x2f, 0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x5f, 0x5f, 0x2f, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x5f,
    0x5f, 0x5f, 0x2f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20};

unsigned char first_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char second_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x4f, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char third_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x4f, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x20, 0x7c, 0x20, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char fourth_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x4f, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x2f, 0x7c, 0x20, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char fifth_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x4f, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x2f, 0x7c, 0x5c, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char sixth_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x4f, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x2f, 0x7c, 0x5c, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x2f, 0x20, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char seventh_frame[] = {
    0x20, 0x20, 0x2b, 0x2d, 0x2d, 0x2d, 0x2b, 0x0a, 0x20, 0x20, 0x7c, 0x20,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x4f, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x20, 0x2f, 0x7c, 0x5c, 0x20, 0x20, 0x7c, 0x0a, 0x20, 0x2f, 0x20, 0x5c,
    0x20, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x0a,
    0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d};

unsigned char *frames[] = {first_frame,  second_frame, third_frame,
                           fourth_frame, fifth_frame,  sixth_frame,
                           seventh_frame};

int validate_args(char *argv[]) {
  for (int i = 0; i < strlen(argv[1]); i++) {
    if (isalpha(argv[1][i]) == 0) {
      return 0;
    }
  }
  if (!((strcmp(argv[2], "easy") == 0) || (strcmp(argv[2], "hard") == 0))) {
    return 0;
  }
  return 1;
}

struct json_string {
  char *ptr;
  size_t len;
};

void init_json_string(struct json_string *s) {
  s->len = 0;
  s->ptr = (char*)malloc(s->len + 1);
  if (s->ptr == NULL) {
    fprintf(stderr, "malloc() failed\n");
    exit(EXIT_FAILURE);
  }
  s->ptr[0] = '\0';
}

size_t writefunc(void *ptr, size_t size, size_t nmemb, struct json_string *s) {
  size_t new_len = s->len + size * nmemb;
  s->ptr = (char*)realloc(s->ptr, new_len + 1);
  if (s->ptr == NULL) {
    fprintf(stderr, "realloc() failed\n");
    exit(EXIT_FAILURE);
  }
  memcpy(s->ptr + s->len, ptr, size * nmemb);
  s->ptr[new_len] = '\0';
  s->len = new_len;

  return size * nmemb;
}

int check_if_play_again(){
    printf("\033[38;5;220m");
    printf("Do you wish to play again?\n");
    printf("[y]es   [n]o\n");

    char user_play_again;
    char c;

    c = getchar();
    if(c != '\n') while(getchar()!='\n');
    while(c != 'y' && c != 'n'){
      printf("Invalid! Enter 'y' to repear or 'n' to end \n");
    c = getchar();
    if(c != '\n') while(getchar()!='\n');
    }
    user_play_again = c;

    if(user_play_again=='y'){
      printf("\033[38;5;46m");
      printf("Reinitializing\n");
      printf("\033[0m"); // restore de default color
      return 1;
    }
    else{
      printf("\033[38;5;46m");
      printf("Bye! Have a good day!\n");
      printf("\033[0m"); // restore de default color
      return 0;
    }
}


int game_loop(char* genre){
  // Fetch related words from api as json_string
  char fetch_url[256] = "https://api.datamuse.com/words?topics=";
  strcat(fetch_url, genre);
  struct json_string s;

  CURLcode res;

  CURL *curl = curl_easy_init();
  if (curl) {
    init_json_string(&s);

    curl_easy_setopt(curl, CURLOPT_URL, fetch_url);
    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, writefunc);
    curl_easy_setopt(curl, CURLOPT_WRITEDATA, &s);
    res = curl_easy_perform(curl);

    if (res != CURLE_OK)
      printf("Fetch request failed: %s\n", curl_easy_strerror(res));

    curl_easy_cleanup(curl);
  }

  // convert string to json

  json_t *root;
  json_error_t error;

  root = json_loads(s.ptr, 0, &error);
  free(s.ptr);

  if (!root) {
    fprintf(stderr, "error: on line %d: %s\n", error.line, error.text);
    return 1;
  }

  // get array of objects
  if (!json_is_array(root)) {
    fprintf(stderr, "error: root is not an array\n");
    json_decref(root);
    return 1;
  }

  const char *word_str;

  srand(time(0));
  int rand_word_index = (rand() % (json_array_size(root))) +
                        1; // random number between 0 and length of array
  // loop through array, each iteration is a word object

  for (int i = 0; i < json_array_size(root); i++) {

    json_t *data, *word, *score, *tags;
    data = json_array_get(root, i);

    if (!json_is_object(data)) {
      fprintf(stderr, "error: word data %d is not an object\n", i + 1);
      json_decref(root);
      return 1;
    }
    if (i == rand_word_index) {
      word = json_object_get(data, "word");
      score = json_object_get(data, "score");
      word_str = json_string_value(word);
    }
  }
  // word set
  int chances = 7;
  char guessed_letters[27];
  guessed_letters[0] = '\0'; // contains all letters guessed
      int guessed_char_index = 0;
  int letters = strlen(word_str);
  char guessed_str[letters+1]; // guessed string (contains letters of the original
                             // string)
  memset(&guessed_str[0], '_', sizeof(guessed_str)-1);
  guessed_str[letters] = '\0';

  //Main game loop
  int play_again = 0;
  while (chances > 0) {
    // print corresponding frame
    system("clear");
    printf("%s\n", frames[7 - chances]);
    printf("\n");
    for (int i = 0; i < letters; i++) {
      printf(" %c ", guessed_str[i]);
    };
    printf("\n");

    if (strcmp(guessed_str, word_str) == 0) {
      printf("\033[38;5;46m");
      printf("\nYou guessed the word!\n\n");
      // sleep(2);
      printf("\033[0m");
      play_again = check_if_play_again();
      break;
    }

    printf("\n\nTake a Guess! ");
    char guess_char;


    char c;
    while ((c = getchar()) != '\n' && c != EOF) {
      guess_char = c;
    }

    if (strchr(guessed_letters, guess_char) != NULL) {
      printf("\033[38;5;196m");
      printf("\nYou already guessed that letter!\n");
      // sleep(2);
      printf("\033[0m");
    } else {
      if (strchr(word_str, guess_char) != NULL) { // if letter is in word
        // printf("\033[38;5;46m");
        // printf("\nCorrectly guessed %c!\n", guess_char);
        // printf("\033[0m");
        // sleep(2);

        guessed_letters[guessed_char_index] = guess_char;
        guessed_letters[guessed_char_index + 1] = '\0';
        guessed_char_index++;

        for (int i = 0; i < letters; i++) {
          if (word_str[i] == guess_char) {
            guessed_str[i] = guess_char;
          }
        }
      } else {
        // printf("\033[38;5;196m");
        // printf("\nIncorrect guess %c!\n", guess_char);
        // printf("\033[0m");
        // sleep(2);
        chances--;
      }
    }
    if (chances == 0) {
      printf("\033[38;5;196m");
      printf("\nYou lost! The word was %s\n", word_str);
      printf("\nBetter Luck Next Time!\n\n");
      // sleep(2);
      printf("\033[0m");
      play_again = check_if_play_again();
    }
  }

  if(play_again){
    return game_loop(genre);
  }

  return 0;
}

int main(int argc, char *argv[]) {
  //    system("clear");
  //For the case when arguments are not given
  if (argc != 3 || validate_args(argv) == 0) {
    printf("\033[38;5;196m");
    printf("%s\n\033[0m", ascii_intro);
    printf("\033[38;5;220m");
    printf("\nWelcome to the hangman CLI!\n\033[0m");
    printf("\033[47;30m");
    printf(" Usage: %s <genre> <difficulty> \033[0m\n\n", argv[0]);
    printf("\033[38;5;206m");
    printf(
        "----------------------------Genre----------------------------\n\n(1 "
        "word str) - Words related to this genre/topic will be fetched\n\n");
    printf("\033[38;5;165m");
    printf("--------------------------Difficulty--------------------------\n\n("
           "1 word str {hard/easy} ) - Sets the difficulty for this round\n\n");
    printf("\033[0m");
    return 1;
  }

  char* genre = argv[1];
  int ret_value = game_loop(genre);

  return 0;

}
